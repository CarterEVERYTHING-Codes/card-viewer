<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiCard Dashboard</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .container {
            width: 50%;
            margin: auto;
            background: #111;
            padding: 20px;
            border-radius: 10px;
        }
        h1, h2 {
            color: cyan;
        }
        .balance {
            color: gold;
            font-size: 1.5em;
        }
        .warning {
            color: red;
            font-weight: bold;
        }
        #confetti {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="container">
    <h1>Welcome, <span id="userName">User</span>!</h1>
    <p class="balance">Balance: <span id="balance">Loading...</span> DigiCredits</p>
    
    <h2>Card Details</h2>
    <p><strong>Card Number:</strong> <span id="cardNumber">Loading...</span></p>
    <p><strong>Expiry:</strong> <span id="expiry">Loading...</span></p>
    <p><strong>CVC:</strong> <span id="cvc">Loading...</span></p>

    <hr>

    <div id="platinumFeatures" style="display: none;">
        <h2>Platinum Features</h2>
        <p><strong>Cashback:</strong> <span id="cashback">Loading...</span></p>
        <p><strong>Credit Score:</strong> <span id="creditScore">Loading...</span></p>
        <p><strong>Debt Due:</strong> <span id="debtDue">Loading...</span> / <span id="maxDebt">Loading...</span> DigiCredits</p>
        <p><strong>Debt Due Date:</strong> <span id="debtDueDate">Loading...</span></p>
        <p id="debtWarning" class="warning" style="display: none;">âš  Warning: You're close to max debt!</p>
    </div>

    <hr>

    <h2>Recent Transactions</h2>
    <ul id="transactions">Loading...</ul>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get("cardId");

        if (!cardId) {
            alert("No Card ID Provided");
            return;
        }

        fetch(`https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec?cardId=${cardId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Fetched Data:", data);

                if (!data || Object.keys(data).length === 0) {
                    alert("No data found for this card.");
                    return;
                }

                // General Card Details
                document.getElementById("userName").innerText = data.Name || "User";
                document.getElementById("balance").innerText = data.Balance || "0";
                document.getElementById("cardNumber").innerText = data.CardNumber || "N/A";
                document.getElementById("expiry").innerText = data.Expiry || "N/A";
                document.getElementById("cvc").innerText = data.CVC || "N/A";

                // Platinum Features
                if (data.Tier === "Platinum") {
                    document.getElementById("platinumFeatures").style.display = "block";
                    document.getElementById("cashback").innerText = data.Cashback || "0";
                    document.getElementById("creditScore").innerText = data.CreditScore || "N/A";
                    document.getElementById("debtDue").innerText = data.DebtDue || "0";
                    document.getElementById("maxDebt").innerText = data.MaxCreditDebt || "N/A";
                    document.getElementById("debtDueDate").innerText = data.DebtDueDate || "N/A";

                    // ðŸš¨ Warning for High Debt
                    if (parseFloat(data.DebtDue) >= 0.9 * parseFloat(data.MaxCreditDebt)) {
                        document.getElementById("debtWarning").style.display = "block";
                    }

                    // ðŸŽ‰ Celebration if Credit Score or Limit Improved
                    let prevCreditScore = localStorage.getItem("prevCreditScore") || data.CreditScore;
                    let prevCreditLimit = localStorage.getItem("prevCreditLimit") || data.MaxCreditDebt;

                    if (parseFloat(data.CreditScore) > parseFloat(prevCreditScore) || 
                        parseFloat(data.MaxCreditDebt) > parseFloat(prevCreditLimit)) {
                        startConfetti();
                        alert("ðŸŽ‰ Congrats! Your credit score or limit has improved!");
                    }

                    // Save new values
                    localStorage.setItem("prevCreditScore", data.CreditScore);
                    localStorage.setItem("prevCreditLimit", data.MaxCreditDebt);
                }

                // Recent Transactions
                const transactionsList = document.getElementById("transactions");
                transactionsList.innerHTML = ""; // Clear list
                if (data.Transactions && data.Transactions.length > 0) {
                    data.Transactions.forEach(tx => {
                        let listItem = document.createElement("li");
                        listItem.innerText = tx;
                        transactionsList.appendChild(listItem);
                    });
                } else {
                    transactionsList.innerText = "No recent transactions.";
                }
            })
            .catch(error => console.error("Fetch error:", error));

        // ðŸŽ‰ Confetti Animation
        function startConfetti() {
            const confettiCanvas = document.getElementById("confetti");
            const confettiCtx = confettiCanvas.getContext("2d");

            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;

            let particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height,
                    r: Math.random() * 4 + 1,
                    d: Math.random() * 2 + 1,
                });
            }

            function drawConfetti() {
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                confettiCtx.fillStyle = "gold";

                particles.forEach(p => {
                    confettiCtx.beginPath();
                    confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2, false);
                    confettiCtx.fill();
                    p.y += p.d;
                    if (p.y > confettiCanvas.height) p.y = 0;
                });

                requestAnimationFrame(drawConfetti);
            }

            drawConfetti();
            setTimeout(() => confettiCanvas.style.display = "none", 5000);
        }
    });
</script>

</body>
</html>
