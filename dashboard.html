<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="favicon.png">
    <style>
        /* Dark Mode Styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            width: 400px;
        }
        h1, h2 {
            color: cyan;
        }
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: gold;
        }
        .card-details, .platinum-features {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid gray;
        }
        .warning {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Welcome, <span id="userName">User</span>!</h1>
        <p class="balance">Balance: <span id="balance">Loading...</span> DigiCredits</p>

        <div class="card-details">
            <h2>Card Details</h2>
            <p><b>Card Number:</b> <span id="cardNumber"></span></p>
            <p><b>Expiry:</b> <span id="expiryDate"></span></p>
            <p><b>CVC:</b> <span id="cvc"></span></p>
        </div>

        <div class="platinum-features" id="platinumSection" style="display: none;">
            <h2>Platinum Features</h2>
            <p><b>Cashback:</b> <span id="cashback">Loading...</span></p>
            <p><b>Credit Score:</b> <span id="creditScore">Loading...</span></p>
            <p><b>Debt Due:</b> <span id="debtDue">Loading...</span></p>
            <p><b>Debt Due Date:</b> <span id="debtDueDate">Loading...</span></p>
        </div>

        <p id="warningMessage" class="warning" style="display: none;"></p>
    </div>

    <script>
        // Fetch data from Google Sheets
        async function fetchData() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get("cardId");

            if (!cardId) {
                alert("No Card ID provided.");
                return;
            }

            try {
                const response = await fetch(`https://script.google.com/macros/s/AKfycbwI_d8Vx9sOuxqFlF-NXML6aoWj4JsXwRavkmvjR_P9Ho1wF2KYHfAeD6nSzcoPtiO4/exec?cardId=${cardId}`);
                const data = await response.json();

                // Set user details
                document.getElementById("userName").innerText = data.name;
                document.getElementById("balance").innerText = data.balance;
                document.getElementById("cardNumber").innerText = data.cardNumber;
                document.getElementById("expiryDate").innerText = data.expiry;
                document.getElementById("cvc").innerText = data.cvc;

                // Show Platinum features if card type is Platinum
                if (data.type === "Platinum") {
                    document.getElementById("platinumSection").style.display = "block";
                    document.getElementById("cashback").innerText = data.cashback || "N/A";
                    document.getElementById("creditScore").innerText = data.creditScore || "N/A";
                    document.getElementById("debtDue").innerText = `${data.debtDue} / ${data.maxDebt} DigiCredits`;
                    document.getElementById("debtDueDate").innerText = data.debtDueDate || "N/A";

                    // Show warning if debt is near max limit
                    if (data.debtDue >= data.maxDebt * 0.8) {
                        document.getElementById("warningMessage").style.display = "block";
                        document.getElementById("warningMessage").innerText = "‚ö†Ô∏è Warning: Your debt is nearing the limit!";
                    }

                    // Celebrate credit score improvement
                    let lastCreditScore = localStorage.getItem("lastCreditScore");
                    if (lastCreditScore && lastCreditScore < data.creditScore) {
                        confettiCelebration();
                        alert("üéâ Your credit score has improved!");
                    } else if (lastCreditScore && lastCreditScore > data.creditScore) {
                        alert("‚ö†Ô∏è Your credit score has worsened.");
                    }
                    localStorage.setItem("lastCreditScore", data.creditScore);
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Failed to fetch card details.");
            }
        }

        // Confetti effect when credit score improves
        function confettiCelebration() {
            const confettiCanvas = document.createElement("canvas");
            confettiCanvas.style.position = "fixed";
            confettiCanvas.style.top = "0";
            confettiCanvas.style.left = "0";
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            document.body.appendChild(confettiCanvas);

            const ctx = confettiCanvas.getContext("2d");
            const confettiParticles = [];

            for (let i = 0; i < 100; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height,
                    speedX: Math.random() * 5 - 2.5,
                    speedY: Math.random() * 5 + 2,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    size: Math.random() * 5 + 2
                });
            }

            function drawConfetti() {
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                confettiParticles.forEach((particle, index) => {
                    ctx.fillStyle = particle.color;
                    ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
                    particle.y += particle.speedY;
                    particle.x += particle.speedX;

                    if (particle.y > confettiCanvas.height) {
                        confettiParticles.splice(index, 1);
                    }
                });

                if (confettiParticles.length > 0) {
                    requestAnimationFrame(drawConfetti);
                } else {
                    document.body.removeChild(confettiCanvas);
                }
            }

            drawConfetti();
        }

        // Run fetchData when the page loads
        fetchData();
    </script>

</body>
</html>
